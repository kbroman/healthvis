// Generated by CoffeeScript 1.4.0
var HealthvisCorrScatter;

HealthvisCorrScatter = function() {
  var h, pad, totalh, totalw, w;
  h = 450;
  w = h;
  pad = {
    left: 70,
    top: 40,
    right: 5,
    bottom: 70
  };
  totalh = h + pad.top + pad.bottom;
  totalw = (w + pad.left + pad.right) * 2;
  this.h = h;
  this.w = w;
  this.pad = pad;
  this.totalh = totalh;
  this.totalw = totalw;
  this.height = totalh;
  this.width = totalw;
  this.init = function(elementID, d3Params) {
    var dimensions;
    dimensions = healthvis.getDimensions(this.width, this.height);
    this.width = dimensions.width;
    this.height = dimensions.height;
    this.innerPad = 5;
    this.circleRadius = d3Params.circleRadius;
    this.svg = d3.select("#main").append("svg").attr("height", this.height).attr("width", this.width).attr('class', 'chart');
    this.corrplot = this.svg.append("g").attr("id", "corrplot").attr("transform", "translate(" + pad.left + "," + pad.top + ")");
    this.scatterplot = this.svg.append("g").attr("id", "scatterplot").attr("transform", "translate(" + (pad.left * 2 + pad.right + w) + "," + pad.top + ")");
    this.indnames = d3Params.indnames;
    this.varnames = d3Params.varnames;
    this.corr = JSON.parse(d3Params.corr);
    this.mat = JSON.parse(d3Params.mat);
    return this.group = d3Params.group;
  };
  this.visualize = function() {
    var cells, circleRadius, colorScale, colors, corXscale, corYscale, corZscale, corr, corrplot, drawScatter, formatAxis, group, i, indnames, innerPad, j, mat, nGroup, nind, nvar, scatterplot, varnames;
    corrplot = this.corrplot;
    scatterplot = this.scatterplot;
    innerPad = this.innerPad;
    circleRadius = this.circleRadius;
    indnames = this.indnames;
    varnames = this.varnames;
    mat = this.mat;
    group = this.group;
    nind = indnames.length;
    nvar = varnames.length;
    corXscale = d3.scale.ordinal().domain(d3.range(nvar)).rangeBands([0, w]);
    corYscale = d3.scale.ordinal().domain(d3.range(nvar)).rangeBands([h, 0]);
    corZscale = d3.scale.linear().domain([-1, 0, 1]).range(["darkslateblue", "white", "crimson"]);
    corr = [];
    for (i in this.corr) {
      for (j in this.corr[i]) {
        corr.push({
          row: i,
          col: j,
          value: this.corr[i][j]
        });
      }
    }
    formatAxis = function(d) {
      var ndig;
      d = d[1] - d[0];
      ndig = Math.floor(Math.log(d % 10) / Math.log(10));
      if (ndig > 0) {
        ndig = 0;
      }
      ndig = Math.abs(ndig);
      return d3.format("." + ndig + "f");
    };
    scatterplot.append("rect").attr("height", h).attr("width", w).attr("fill", d3.rgb(200, 200, 200)).attr("stroke", "black").attr("stroke-width", 1).attr("pointer-events", "none");
    cells = corrplot.selectAll("empty").data(corr).enter().append("rect").attr("class", "cell").attr("x", function(d) {
      return corXscale(d.col);
    }).attr("y", function(d) {
      return corYscale(d.row);
    }).attr("width", corXscale.rangeBand()).attr("height", corYscale.rangeBand()).attr("fill", function(d) {
      return corZscale(d.value);
    }).attr("stroke", "none").attr("stroke-width", 2).on("mouseover", function(d) {
      d3.select(this).attr("stroke", "black");
      corrplot.append("text").attr("id", "corrtext").text(d3.format(".2f")(d.value)).attr("x", function() {
        var mult;
        mult = -1;
        if (d.col < nvar / 2) {
          mult = +1;
        }
        return corXscale(d.col) + mult * 30;
      }).attr("y", function() {
        var mult;
        mult = +1;
        if (d.row < nvar / 2) {
          mult = -1;
        }
        return corYscale(d.row) + (mult + 0.35) * 20;
      }).attr("fill", "black").attr("dominant-baseline", "middle").attr("text-anchor", "middle");
      corrplot.append("text").attr("class", "corrlabel").attr("x", corXscale(d.col)).attr("y", h + pad.bottom * 0.2).text(varnames[d.col]).attr("dominant-baseline", "middle").attr("text-anchor", "middle");
      return corrplot.append("text").attr("class", "corrlabel").attr("y", corYscale(d.row)).attr("x", -pad.left * 0.1).text(varnames[d.row]).attr("dominant-baseline", "middle").attr("text-anchor", "end");
    }).on("mouseout", function() {
      d3.selectAll("text.corrlabel").remove();
      d3.selectAll("text#corrtext").remove();
      return d3.select(this).attr("stroke", "none");
    }).on("click", function(d) {
      return drawScatter(d.col, d.row);
    });
    nGroup = d3.max(group);
    if (nGroup === 1) {
      colors = [d3.rgb(150, 150, 150)];
    } else if (nGroup <= 3) {
      colors = ["crimson", "green", "darkslateblue"];
    } else {
      if (nGroup <= 10) {
        colorScale = d3.scale.category10();
      } else {
        colorScale = d3.scale.category20();
      }
      colors = (function() {
        var _results;
        _results = [];
        for (i in d3.range(nGroup)) {
          _results.push(colorScale(i));
        }
        return _results;
      })();
    }
    drawScatter = function(i, j) {
      var d, x, xScale, xticks, y, yScale, yticks, z, _i, _len, _ref;
      d3.selectAll("circle.points").remove();
      d3.selectAll("text.axes").remove();
      d3.selectAll("line.axes").remove();
      x = [];
      y = [];
      z = [];
      _ref = d3.range(nind);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        d = _ref[_i];
        if (mat[i][d] !== "NA" && mat[j][d] !== "NA") {
          x.push(mat[i][d]);
          y.push(mat[j][d]);
          z.push(group[d]);
        }
      }
      if (x.length === 0) {
        return null;
      }
      xScale = d3.scale.linear().domain(d3.extent(x)).range([innerPad, w - innerPad]);
      yScale = d3.scale.linear().domain(d3.extent(y)).range([h - innerPad, innerPad]);
      scatterplot.append("text").attr("id", "xaxis").attr("class", "axes").attr("x", w / 2).attr("y", h + pad.bottom * 0.7).text(varnames[i]).attr("dominant-baseline", "middle").attr("text-anchor", "middle").attr("fill", "slateblue");
      scatterplot.append("text").attr("id", "yaxis").attr("class", "axes").attr("x", -pad.left * 0.8).attr("y", h / 2).text(varnames[j]).attr("dominant-baseline", "middle").attr("text-anchor", "middle").attr("transform", "rotate(270," + (-pad.left * 0.8) + "," + (h / 2) + ")").attr("fill", "slateblue");
      xticks = xScale.ticks(5);
      yticks = yScale.ticks(5);
      scatterplot.selectAll("empty").data(xticks).enter().append("text").attr("class", "axes").text(function(d) {
        return formatAxis(xticks)(d);
      }).attr("x", function(d) {
        return xScale(d);
      }).attr("y", h + pad.bottom * 0.3).attr("dominant-baseline", "middle").attr("text-anchor", "middle");
      scatterplot.selectAll("empty").data(yticks).enter().append("text").attr("class", "axes").text(function(d) {
        return formatAxis(yticks)(d);
      }).attr("x", -pad.left * 0.1).attr("y", function(d) {
        return yScale(d);
      }).attr("dominant-baseline", "middle").attr("text-anchor", "end");
      scatterplot.selectAll("empty").data(xticks).enter().append("line").attr("class", "axes").attr("x1", function(d) {
        return xScale(d);
      }).attr("x2", function(d) {
        return xScale(d);
      }).attr("y1", 0).attr("y2", h).attr("stroke", "white").attr("stroke-width", 1);
      scatterplot.selectAll("empty").data(yticks).enter().append("line").attr("class", "axes").attr("y1", function(d) {
        return yScale(d);
      }).attr("y2", function(d) {
        return yScale(d);
      }).attr("x1", 0).attr("x2", w).attr("stroke", "white").attr("stroke-width", 1);
      return scatterplot.selectAll("empty").data(x).enter().append("circle").attr("class", "points").attr("cx", function(d, i) {
        return xScale(x[i]);
      }).attr("cy", function(d, i) {
        return yScale(y[i]);
      }).attr("r", circleRadius).attr("stroke", "black").attr("stroke-width", 1).attr("fill", function(d, i) {
        return colors[z[i] - 1];
      });
    };
    corrplot.append("rect").attr("height", h).attr("width", w).attr("fill", "none").attr("stroke", "black").attr("stroke-width", 1).attr("pointer-events", "none");
    scatterplot.append("rect").attr("height", h).attr("width", w).attr("fill", "none").attr("stroke", "black").attr("stroke-width", 1).attr("pointer-events", "none");
    corrplot.append("text").text("Correlation matrix").attr("id", "corrtitle").attr("x", w / 2).attr("y", -pad.top / 2).attr("dominant-baseline", "middle").attr("text-anchor", "middle");
    return scatterplot.append("text").text("Scatterplot").attr("id", "corrtitle").attr("x", w / 2).attr("y", -pad.top / 2).attr("dominant-baseline", "middle").attr("text-anchor", "middle");
  };
  this.update = function(formdata) {
    return null;
  };
  return null;
};

healthvis.register(new HealthvisCorrScatter());
